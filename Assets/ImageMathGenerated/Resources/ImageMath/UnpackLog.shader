Shader "ImageMath/UnpackLog"{
    Properties {}
    SubShader {
        Cull Off ZWrite Off ZTest Always
        ColorMask[ImageMath_ChannelMask]

        CGINCLUDE
        
        #include "UnityCG.cginc"

        #define Pi 3.1415926535897932384626433832795
        #define SquareRootOf2 1.4142135623730950488016887242097
        #define Epsilon 10e-6

        struct VSI {
            float4 position : POSITION;
            float2 uv : TEXCOORD0;
        };
        
        struct VSO {
            float4 position : SV_POSITION;
            float2 uv : TEXCOORD0;
        };

        float3 ImageMath_V2;
        #define WhiteLevel ImageMath_V2
        float3 ImageMath_V3;
        #define BlackLevel ImageMath_V3
        float3 ImageMath_V4;
        #define ExponentScale ImageMath_V4
        Texture2D<float4> ImageMath_T0;
        #define Texture ImageMath_T0
        SamplerState samplerImageMath_T0;
        #define samplerTexture samplerImageMath_T0
        float2 ImageMath_V0;
        #define Position ImageMath_V0
        float2 ImageMath_V1;
        #define Size ImageMath_V1

        VSO vert(VSI input) {
            VSO result;
            result.position = input.position;
            result.position.xy *= Size;
        	result.position.xy += Position;
        	result.position = UnityObjectToClipPos(result.position);
            result.uv = input.uv;
            return result;
        }
        
        float4 frag(VSO input) : SV_Target {
            float4 inputColor = Texture.Sample(samplerTexture, input.uv);
                float3 range = WhiteLevel - BlackLevel;
                float3 x = (inputColor.rgb - BlackLevel) / range;
            
                float3 exponentScale = ExponentScale * range;
            
                x = pow(2, x * exponentScale) - 1;
                float3 divider = pow(2, exponentScale) - 1;
                x /= divider;
            
                return float4(x.r, x.g, x.b, inputColor.a);
        }

        ENDCG

        Pass {
            CGPROGRAM
            #pragma vertex vert
            #pragma fragment frag            
            ENDCG
        }

        Pass{
            Blend One One
            CGPROGRAM
            #pragma vertex vert
            #pragma fragment frag            
            ENDCG
        }

        Pass{
            Blend DstColor Zero
            CGPROGRAM
            #pragma vertex vert
            #pragma fragment frag            
            ENDCG
        }

        Pass{
            Blend SrcAlpha OneMinusSrcAlpha
            CGPROGRAM
            #pragma vertex vert
            #pragma fragment frag            
            ENDCG
        }

        Pass{
            Blend One One
            BlendOp Max
            CGPROGRAM
            #pragma vertex vert
            #pragma fragment frag            
            ENDCG
        }

        Pass{
            Blend One One
            BlendOp Min
            CGPROGRAM
            #pragma vertex vert
            #pragma fragment frag            
            ENDCG
        }

    }
}
